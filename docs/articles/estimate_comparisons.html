<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="redistribute">
<title>Estimate Comparisons • redistribute</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate Comparisons">
<meta property="og:description" content="redistribute">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">redistribute</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Introduction</a>
    <a class="dropdown-item" href="../articles/estimate_comparisons.html">Method Comparisons</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/uva-bi-sdad/redistribute/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Estimate Comparisons</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/uva-bi-sdad/redistribute/blob/HEAD/vignettes/estimate_comparisons.Rmd" class="external-link"><code>vignettes/estimate_comparisons.Rmd</code></a></small>
      <div class="d-none name"><code>estimate_comparisons.Rmd</code></div>
    </div>

    
    
<p><em>Built with R 4.2.2</em></p>
<hr>
<p>Redistribution means rearranging values such that totals remain the
same, and the original distribution could be recovered when
re-aggregating from a perfectly contained disaggregate.</p>
<p>This may be desirable if your goal is to simply display the same data
in different forms.</p>
<p>If, however, your goal is to come up with values at scales you don’t
have observations of, it may be desirable to combine various
observations at different scales and use them to come up with new
estimates.</p>
<p>In the case of estimation, there are many more methods to consider,
and validating their results is less straightforward, so this article
will consider a few estimation and validation methods.</p>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>We’ll focus on a single county (Arlington, VA), with census block
groups and Public Use Microdata Samples (PUMS) as our primary source
data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># directory to save data in</span></span>
<span><span class="va">base_dir</span> <span class="op">&lt;-</span> <span class="st">"../estimate_comparison"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># geographies</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">catchment</span><span class="op">)</span></span>
<span><span class="va">geography_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/catchment/man/download_census_shapes.html" class="external-link">download_census_shapes</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"va"</span>, <span class="st">"bg"</span>, year <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span></span>
<span><span class="va">geography_bg</span> <span class="op">&lt;-</span> <span class="va">geography_bg</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^51013"</span>, <span class="va">geography_bg</span><span class="op">$</span><span class="va">GEOID</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">geography_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/catchment/man/download_census_shapes.html" class="external-link">download_census_shapes</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"va"</span>, <span class="st">"tr"</span>, year <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span></span>
<span><span class="va">geography_tr</span> <span class="op">&lt;-</span> <span class="va">geography_tr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^51013"</span>, <span class="va">geography_tr</span><span class="op">$</span><span class="va">GEOID</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># ACS data</span></span>
<span></span>
<span><span class="co">## block groups</span></span>
<span><span class="va">block_groups</span> <span class="op">&lt;-</span> <span class="fu">tidycensus</span><span class="fu">::</span><span class="fu"><a href="https://walker-data.com/tidycensus/reference/get_acs.html" class="external-link">get_acs</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fl">2021</span>,</span>
<span>  state <span class="op">=</span> <span class="st">"51"</span>,</span>
<span>  county <span class="op">=</span> <span class="st">"013"</span>,</span>
<span>  geography <span class="op">=</span> <span class="st">"block group"</span>,</span>
<span>  output <span class="op">=</span> <span class="st">"wide"</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    total <span class="op">=</span> <span class="st">"B01001_001"</span>,</span>
<span>    race_white <span class="op">=</span> <span class="st">"B02001_002"</span>,</span>
<span>    race_black <span class="op">=</span> <span class="st">"B02001_003"</span>,</span>
<span>    race_native <span class="op">=</span> <span class="st">"B02001_004"</span>,</span>
<span>    race_asian <span class="op">=</span> <span class="st">"B02001_005"</span>,</span>
<span>    sex_male <span class="op">=</span> <span class="st">"B01001_002"</span>,</span>
<span>    sex_female <span class="op">=</span> <span class="st">"B01001_026"</span>,</span>
<span>    tenure_total <span class="op">=</span> <span class="st">"B25003_001"</span>,</span>
<span>    tenure_owner <span class="op">=</span> <span class="st">"B25003_002"</span>,</span>
<span>    tenure_renter <span class="op">=</span> <span class="st">"B25003_003"</span>,</span>
<span>    income_total <span class="op">=</span> <span class="st">"B19001_001"</span>,</span>
<span>    income_lt10 <span class="op">=</span> <span class="st">"B19001_002"</span>,</span>
<span>    income_10_15 <span class="op">=</span> <span class="st">"B19001_003"</span>,</span>
<span>    income_15_20 <span class="op">=</span> <span class="st">"B19001_004"</span>,</span>
<span>    income_20_25 <span class="op">=</span> <span class="st">"B19001_005"</span>,</span>
<span>    income_25_30 <span class="op">=</span> <span class="st">"B19001_006"</span>,</span>
<span>    income_30_35 <span class="op">=</span> <span class="st">"B19001_007"</span>,</span>
<span>    income_35_40 <span class="op">=</span> <span class="st">"B19001_008"</span>,</span>
<span>    income_40_45 <span class="op">=</span> <span class="st">"B19001_009"</span>,</span>
<span>    income_45_50 <span class="op">=</span> <span class="st">"B19001_010"</span>,</span>
<span>    income_100_125 <span class="op">=</span> <span class="st">"B19001_014"</span>,</span>
<span>    income_125_150 <span class="op">=</span> <span class="st">"B19001_015"</span>,</span>
<span>    income_150_200 <span class="op">=</span> <span class="st">"B19001_016"</span>,</span>
<span>    income_gt200 <span class="op">=</span> <span class="st">"B19001_017"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; Getting data from the 2017-2021 5-year ACS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">block_groups</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Total"</span></span>
<span><span class="va">block_groups</span><span class="op">$</span><span class="va">race_other</span> <span class="op">&lt;-</span> <span class="va">block_groups</span><span class="op">$</span><span class="va">Total</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span></span>
<span>  <span class="va">block_groups</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^race_.*E$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">block_groups</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">block_groups</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"E$"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">block_groups</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">block_groups</span> <span class="op">&lt;-</span> <span class="va">block_groups</span><span class="op">[</span><span class="va">block_groups</span><span class="op">$</span><span class="va">Total</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">geography_bg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">geography_bg</span><span class="op">$</span><span class="va">GEOID</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">block_groups</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">geography_bg</span><span class="op">[</span><span class="va">block_groups</span><span class="op">$</span><span class="va">GEOID</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># parcel data</span></span>
<span><span class="va">parcel_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"/parcels.rds"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">parcel_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">parcels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://arlgis.arlingtonva.us/arcgis/rest/services/Open_Data/od_MHUD_Polygons/"</span>,</span>
<span>    <span class="st">"FeatureServer/0/query?where=1=1&amp;outFields=*&amp;outSR=4326&amp;f=json"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">parcels</span>, <span class="va">parcel_file</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">parcels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">parcel_file</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">parcels</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">parcels</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Total_Units"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Total"</span></span>
<span><span class="va">parcels</span><span class="op">$</span><span class="va">tract</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substring</a></span><span class="op">(</span><span class="va">parcels</span><span class="op">$</span><span class="va">Full_Block</span>, <span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">parcels</span> <span class="op">&lt;-</span> <span class="va">parcels</span><span class="op">[</span><span class="va">parcels</span><span class="op">$</span><span class="va">Year_Built</span> <span class="op">&lt;=</span> <span class="fl">2021</span>, <span class="op">]</span></span></code></pre></div>
<p>Ultimately, we’ll want to use these methods to get values for
unobserved geographies, but for this comparison of methods, we’ll want a
way to test their results against known values.</p>
<p>For this test case, we can simply start at a higher geolayer, and
make estimates at the block group level. To do that, we’ll need to
aggregate our block group data up to tracts:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tracts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span><span class="va">block_groups</span>, <span class="va">geography_tr</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="redistribution">Redistribution<a class="anchor" aria-label="anchor" href="#redistribution"></a>
</h2>
<p>As a baseline, the first method to consider is proportional
redistribution of the block group summary estimates alone.</p>
<div class="section level3">
<h3 id="direct">Direct<a class="anchor" aria-label="anchor" href="#direct"></a>
</h3>
<p>We could do this from tracts to block groups directly:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># going from tracts to block groups with no information</span></span>
<span><span class="va">estimate_tr_to_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>  <span class="va">tracts</span>, <span class="va">block_groups</span>,</span>
<span>  source_id <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mean absolute error between total population estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">estimate_tr_to_bg</span><span class="op">$</span><span class="va">Total</span> <span class="op">-</span> <span class="va">block_groups</span><span class="op">$</span><span class="va">Total</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 303.938</span></span></code></pre></div>
<p>We can see in this case, the error introduce when we only have
proportional information at the lower level; block groups that once
varied within tract now have the same value:</p>
<p><img src="estimate_comparisons_files/figure-html/unnamed-chunk-5-1.svg" width="50%"><img src="estimate_comparisons_files/figure-html/unnamed-chunk-5-2.svg" width="50%"></p>
</div>
<div class="section level3">
<h3 id="down-and-up">Down and Up<a class="anchor" aria-label="anchor" href="#down-and-up"></a>
</h3>
<p>Or we could go from tracts down to parcels, then back up to block
groups:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to apply tract to parcel to block group redistribution</span></span>
<span><span class="va">redist_downup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">top</span>, <span class="va">bottom</span>, <span class="va">middle</span>, <span class="va">map_tb</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">map_bm</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">weight</span> <span class="op">=</span> <span class="st">"Total"</span>, <span class="va">source_id</span> <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    <span class="va">target_id</span> <span class="op">=</span> <span class="st">"OBJECTID"</span>, <span class="va">target_id_mid</span> <span class="op">=</span> <span class="st">"GEOID"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">to_bottom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>    <span class="va">top</span>, <span class="va">bottom</span>, <span class="va">map_tb</span>,</span>
<span>    weight <span class="op">=</span> <span class="va">weight</span>, source_id <span class="op">=</span> <span class="va">source_id</span>, target_id <span class="op">=</span> <span class="va">target_id</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>    <span class="va">to_bottom</span>, <span class="va">middle</span>, <span class="va">map_bm</span>,</span>
<span>    source_id <span class="op">=</span> <span class="st">"id"</span>, target_id <span class="op">=</span> <span class="va">target_id_mid</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># pre-make maps</span></span>
<span></span>
<span><span class="co">## going from tracts to parcels</span></span>
<span><span class="va">map_tr_to_parcel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>  <span class="va">tracts</span>, <span class="va">parcels</span>,</span>
<span>  source_id <span class="op">=</span> <span class="st">"id"</span>, target_id <span class="op">=</span> <span class="st">"OBJECTID"</span>, return_map <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## and from parcels to block groups</span></span>
<span><span class="va">map_parcel_to_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>  <span class="va">parcels</span>, <span class="va">block_groups</span>,</span>
<span>  source_id <span class="op">=</span> <span class="st">"OBJECTID"</span>, target_id <span class="op">=</span> <span class="st">"GEOID"</span>, return_map <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># redistribute</span></span>
<span><span class="va">estimate_redist</span> <span class="op">&lt;-</span> <span class="fu">redist_downup</span><span class="op">(</span></span>
<span>  <span class="va">tracts</span>, <span class="va">parcels</span>, <span class="va">block_groups</span>, <span class="va">map_tr_to_parcel</span>, <span class="va">map_parcel_to_bg</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mean absolute error between total population estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">estimate_redist</span><span class="op">$</span><span class="va">Total</span> <span class="op">-</span> <span class="va">block_groups</span><span class="op">$</span><span class="va">Total</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 222.5203</span></span></code></pre></div>
<p>Now there is more of the original variation between block groups:</p>
<p><img src="estimate_comparisons_files/figure-html/unnamed-chunk-7-1.svg" width="50%"><img src="estimate_comparisons_files/figure-html/unnamed-chunk-7-2.svg" width="50%"></p>
<p>Because the parcel totals are living units rather than individuals,
we may be able to refine our redistribution based on some heuristic
estimates (with some tweaking) of number of people per living unit:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># start with number of units</span></span>
<span><span class="va">parcels</span><span class="op">$</span><span class="va">Residents</span> <span class="op">&lt;-</span> <span class="va">parcels</span><span class="op">$</span><span class="va">Total</span></span>
<span></span>
<span><span class="co">## for parcels with more than 1 unit, assume 2.255 per unit</span></span>
<span><span class="va">su</span> <span class="op">&lt;-</span> <span class="va">parcels</span><span class="op">$</span><span class="va">Total</span> <span class="op">&gt;</span> <span class="fl">1</span></span>
<span><span class="va">parcels</span><span class="op">$</span><span class="va">Residents</span><span class="op">[</span><span class="va">su</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">parcels</span><span class="op">$</span><span class="va">Total</span><span class="op">[</span><span class="va">su</span><span class="op">]</span> <span class="op">*</span> <span class="fl">2.255</span></span>
<span></span>
<span><span class="co">## for 1-unit parcels, base on size</span></span>
<span><span class="va">su</span> <span class="op">&lt;-</span> <span class="va">parcels</span><span class="op">$</span><span class="va">Total</span> <span class="op">==</span> <span class="fl">1</span></span>
<span><span class="va">parcels</span><span class="op">$</span><span class="va">Residents</span><span class="op">[</span><span class="va">su</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>  <span class="va">parcels</span><span class="op">$</span><span class="va">Shape__Area</span><span class="op">[</span><span class="va">su</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">9170</span>, <span class="fl">9550</span>, <span class="fl">48000</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">4</span></span>
<span><span class="va">parcels</span><span class="op">$</span><span class="va">Residents</span><span class="op">[</span><span class="va">su</span> <span class="op">&amp;</span> <span class="va">parcels</span><span class="op">$</span><span class="va">Residents</span> <span class="op">&gt;</span> <span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">137.7</span></span>
<span></span>
<span><span class="co"># now see if this improved our redistribution</span></span>
<span><span class="va">estimate_redist_adj</span> <span class="op">&lt;-</span> <span class="fu">redist_downup</span><span class="op">(</span></span>
<span>  <span class="va">tracts</span>, <span class="va">parcels</span>, <span class="va">block_groups</span>, <span class="va">map_tr_to_parcel</span>, <span class="va">map_parcel_to_bg</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"Residents"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mean absolute error between total population estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">estimate_redist_adj</span><span class="op">$</span><span class="va">Total</span> <span class="op">-</span> <span class="va">block_groups</span><span class="op">$</span><span class="va">Total</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 180.7739</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>So far, we’ve used some additional information (total units) at the
parcel level to improve the distribution of values across block groups,
relative to a uniform distribution.</p>
<p>We have some more information at the parcel level, such as unit type
and number of renter versus owner designations, but to make use of this
information, we need some association between source values and those
features. This is where the census microdata sample can come in: The
Public Use Microdata Sample (PUMS) consists of individual-level
observations that include demographic features and housing features.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pums</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_census_pums.html">download_census_pums</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"va"</span>, <span class="fl">2021</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> loading household sample: <span style="color: #00BB00;">h1-Year.csv.xz</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> loading person sample: <span style="color: #00BB00;">p1-Year.csv.xz</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> loading crosswalk <span style="color: #00BB00;">2020_Census_Tract_to_2020_PUMA.txt</span></span></span>
<span></span>
<span><span class="co"># prepare IDs</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">GEOID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste0</span>, <span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">paste0</span>, <span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SERIALNO"</span>, <span class="st">"SPORDER"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># prepare variables</span></span>
<span></span>
<span><span class="co">## survey categories</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">sex_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sex_male"</span>, <span class="st">"sex_female"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">SEX</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">race_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"race_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"white"</span>, <span class="st">"black"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"native"</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"asian"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"other"</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">RAC1P</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">income_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"income_\\d[_0-9]+$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tracts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">income_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">HINCP</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="op">-</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^income_|_[0-9]+$"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tracts</span><span class="op">)</span><span class="op">[</span><span class="va">income_cols</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fl">200</span>, <span class="cn">Inf</span></span>
<span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"income_lt10"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tracts</span><span class="op">)</span><span class="op">[</span><span class="va">income_cols</span><span class="op">]</span>, <span class="st">"income_gt200"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## unit categories</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">building_type</span> <span class="op">&lt;-</span> <span class="st">"OTHER"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">building_type</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">BLD</span> <span class="op">==</span> <span class="st">"02"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"SFD"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">building_type</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">BLD</span> <span class="op">==</span> <span class="st">"03"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"SFA"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">building_type</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">BLD</span><span class="op">)</span> <span class="op">|</span> <span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">BLD</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"MULTI"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span> <span class="op">&lt;-</span> <span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">building_type</span> <span class="op">!=</span> <span class="st">"OTHER"</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">status</span> <span class="op">&lt;-</span> <span class="st">"OTHER"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">status</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">TEN</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"OWNER"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">status</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">TEN</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"RENTER"</span></span>
<span><span class="va">pums</span><span class="op">$</span><span class="va">household</span> <span class="op">&lt;-</span> <span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"OTHER"</span>, <span class="op">]</span></span></code></pre></div>
<p>The PUM sample is only located down to PUM areas, which are made up
of tracts, so this is where we can start for a baseline.</p>
<p>We will use associations between demographic and housing features
within each PUMA to get probabilities at the parcel level, then
redistribute our source values to them like before.</p>
<p>The first step to this end is to prepare our data so it is easy to
associate the individual PUMS variables with their per-level summaries
at the tract level:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define variables of interest</span></span>
<span><span class="va">vars_house</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  ID <span class="op">=</span> <span class="st">"SERIALNO"</span>, weight <span class="op">=</span> <span class="st">"WGTP"</span>, type <span class="op">=</span> <span class="st">"building_type"</span>,</span>
<span>  status <span class="op">=</span> <span class="st">"status"</span>, income <span class="op">=</span> <span class="st">"income_cat"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">vars_person</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  ID <span class="op">=</span> <span class="st">"ID"</span>, weight <span class="op">=</span> <span class="st">"PWGTP"</span>, sex_cat <span class="op">=</span> <span class="st">"sex_cat"</span>, race_cat <span class="op">=</span> <span class="st">"race_cat"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">vars_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"Unit_Type"</span>, renters <span class="op">=</span> <span class="st">"Renter_Occupied"</span>, owners <span class="op">=</span> <span class="st">"Owner_Occupied"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## get their levels</span></span>
<span><span class="va">vars_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">vars_person</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  income_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">income_cat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">vars_list</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">return_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># prepare datasets split into PUMAs</span></span>
<span><span class="va">pumas_focal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">PUMA5CE</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">GEOID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tracts</span><span class="op">$</span><span class="va">id</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="va">pumas_focal</span>, names <span class="op">=</span> <span class="va">pumas_focal</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">puma</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">households</span> <span class="op">&lt;-</span> <span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">household</span><span class="op">$</span><span class="va">PUMA</span> <span class="op">==</span> <span class="va">puma</span>, <span class="va">vars_house</span><span class="op">]</span></span>
<span>  <span class="va">ids</span> <span class="op">&lt;-</span> <span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">GEOID</span><span class="op">[</span></span>
<span>    <span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">PUMA5CE</span> <span class="op">==</span> <span class="va">puma</span> <span class="op">&amp;</span> <span class="va">pums</span><span class="op">$</span><span class="va">crosswalk</span><span class="op">$</span><span class="va">GEOID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tracts</span><span class="op">$</span><span class="va">id</span></span>
<span>  <span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    households <span class="op">=</span> <span class="va">households</span>,</span>
<span>    individuals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">households</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">households</span><span class="op">[</span><span class="va">r</span>, <span class="op">]</span></span>
<span>      <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">[</span><span class="va">pums</span><span class="op">$</span><span class="va">person</span><span class="op">$</span><span class="va">SERIALNO</span> <span class="op">==</span> <span class="va">h</span><span class="op">$</span><span class="va">SERIALNO</span>, <span class="va">vars_person</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">h</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    source <span class="op">=</span> <span class="va">tracts</span><span class="op">[</span><span class="va">tracts</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="va">vars</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span>,</span>
<span>    parcels <span class="op">=</span> <span class="va">parcels</span><span class="op">[</span></span>
<span>      <span class="va">parcels</span><span class="op">$</span><span class="va">tract</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tract"</span>, <span class="st">"OBJECTID"</span>, <span class="va">vars_units</span><span class="op">)</span>,</span>
<span>      drop <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># function to apply each method to the data</span></span>
<span><span class="va">apply_method</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">method</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="kw">function</span><span class="op">(</span><span class="va">set</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">set</span><span class="op">$</span><span class="va">source</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">source</span> <span class="op">&lt;-</span> <span class="va">set</span><span class="op">$</span><span class="va">source</span><span class="op">[</span><span class="va">set</span><span class="op">$</span><span class="va">source</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">id</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="va">target</span> <span class="op">&lt;-</span> <span class="va">set</span><span class="op">$</span><span class="va">parcels</span><span class="op">[</span><span class="kw">if</span> <span class="op">(</span><span class="st">"map"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">set</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">set</span><span class="op">$</span><span class="va">parcels</span><span class="op">$</span><span class="va">tract</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substring</a></span><span class="op">(</span><span class="va">set</span><span class="op">$</span><span class="va">map</span><span class="op">[[</span><span class="va">id</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">set</span><span class="op">$</span><span class="va">parcels</span><span class="op">$</span><span class="va">tract</span> <span class="op">==</span> <span class="va">id</span></span>
<span>      <span class="op">}</span>, <span class="op">]</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">method</span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">set</span><span class="op">$</span><span class="va">individuals</span><span class="op">)</span></span>
<span>        <span class="va">su</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="va">vars</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span><span class="op">)</span> <span class="va">est</span><span class="op">[</span>, <span class="va">vars</span><span class="op">[</span><span class="va">su</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="va">est</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="va">OBJECTID</span><span class="op">)</span>, <span class="va">vars</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parcels <span class="op">=</span> <span class="va">p</span>, block_groups <span class="op">=</span> <span class="fu"><a href="../reference/redistribute.html">redistribute</a></span><span class="op">(</span></span>
<span>    <span class="va">p</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">block_groups</span>, <span class="va">map_parcel_to_bg</span>,</span>
<span>    source_id <span class="op">=</span> <span class="st">"OBJECTID"</span>, target_id <span class="op">=</span> <span class="st">"GEOID"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can apply each method to this same set of data.</p>
<div class="section level3">
<h3 id="initial-weights">Initial Weights<a class="anchor" aria-label="anchor" href="#initial-weights"></a>
</h3>
<p>As a baseline, we can calculate a set of proportions for each PUMA,
then apply that to the parcels in each contained tract:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to apply the method:</span></span>
<span><span class="co"># - source: the tract-level totals</span></span>
<span><span class="co"># - target: the parcels</span></span>
<span><span class="co"># - individuals: the individual PUM responses</span></span>
<span><span class="va">est_baseline</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span>, <span class="va">individuals</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">target</span><span class="op">[</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span> <span class="op">==</span> <span class="va">type</span>, <span class="op">]</span></span>
<span>    <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">individuals</span><span class="op">[</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span> <span class="op">==</span> <span class="va">type</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PWGTP"</span>, <span class="st">"status"</span>, <span class="va">return_vars</span><span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="va">i</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span></span>
<span>      <span class="va">weight_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">PWGTP</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">return_vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">PWGTP</span>, <span class="va">ii</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">/</span> <span class="va">weight_total</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="va">vars_list</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">!</span><span class="va">vars_list</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>          <span class="va">d</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">props</span>, each <span class="op">=</span> <span class="va">nd</span><span class="op">)</span>,</span>
<span>          <span class="va">nd</span>,</span>
<span>          dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">OBJECTID</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># apply across PUMAs and tracts within them</span></span>
<span><span class="co"># and aggregate to block groups</span></span>
<span><span class="va">estimate_baseline</span> <span class="op">&lt;-</span> <span class="fu">apply_method</span><span class="op">(</span><span class="va">data</span>, <span class="va">est_baseline</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="raking">Raking<a class="anchor" aria-label="anchor" href="#raking"></a>
</h3>
<p>In the baseline, we’re using PUMS weights to calculate proportions,
but these weights are meant to bring totals in line with PUMA-level
estimates; Since we have lower-level information in the form of
tract-level totals, we can adjust those weights to match each
smaller-area summary:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">anesrake</span><span class="op">)</span></span>
<span><span class="va">rake_prep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">var</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">totals</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="va">su</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">|</span> <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">individuals</span> <span class="op">&lt;-</span> <span class="va">individuals</span><span class="op">[</span><span class="op">!</span><span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span>, <span class="op">]</span></span>
<span>        <span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>, exclude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">su</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">totals</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Filter</a></span><span class="op">(</span><span class="va">length</span>, <span class="va">totals</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">est_rake</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span>, <span class="va">individuals</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">source</span><span class="op">[</span>, <span class="va">vars_list</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">rake_prep</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">individuals</span><span class="op">$</span><span class="va">status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">status</span><span class="op">)</span></span>
<span>  <span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span><span class="op">)</span></span>
<span>  <span class="va">individuals</span><span class="op">$</span><span class="va">income_cat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">income_cat</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/anesrake/man/anesrake.html" class="external-link">anesrake</a></span><span class="op">(</span></span>
<span>      <span class="va">totals</span>, <span class="va">individuals</span>, <span class="va">individuals</span><span class="op">$</span><span class="va">ID</span>, <span class="va">individuals</span><span class="op">$</span><span class="va">PWGTP</span>,</span>
<span>      pctlim <span class="op">=</span> <span class="fl">.001</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">weightvec</span><span class="op">[</span><span class="va">individuals</span><span class="op">$</span><span class="va">ID</span><span class="op">]</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">PWGTP</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculate proportions, and estimate parcel values</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">target</span><span class="op">[</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span> <span class="op">==</span> <span class="va">type</span>, <span class="op">]</span></span>
<span>    <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">individuals</span><span class="op">[</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span> <span class="op">==</span> <span class="va">type</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"weight"</span>, <span class="st">"status"</span>, <span class="va">return_vars</span><span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="va">i</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">return_vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span>, <span class="va">ii</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>          <span class="va">d</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">props</span>, each <span class="op">=</span> <span class="va">nd</span><span class="op">)</span>,</span>
<span>          <span class="va">nd</span>,</span>
<span>          dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">OBJECTID</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">estimate_rake</span> <span class="op">&lt;-</span> <span class="fu">apply_method</span><span class="op">(</span><span class="va">data</span>, <span class="va">est_rake</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="two-step-raking">Two Step Raking<a class="anchor" aria-label="anchor" href="#two-step-raking"></a>
</h3>
<p>In the initial raking approach, we only considered the person-level
variables, but we also have household-level information, so we might try
to account for this as well by first adjusting the household weights,
then using those adjusted weights to initialize the adjusted
person-level weights:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_twostep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span>, <span class="va">individuals</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># step 1: initial weights at household level</span></span>
<span>  <span class="va">totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    building_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>    status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    income_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">source</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^income_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">rake_prep</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/anesrake/man/anesrake.html" class="external-link">anesrake</a></span><span class="op">(</span></span>
<span>      <span class="va">totals</span>, <span class="va">individuals</span>, <span class="va">individuals</span><span class="op">$</span><span class="va">SERIALNO</span>, <span class="va">individuals</span><span class="op">$</span><span class="va">WGTP</span>,</span>
<span>      pctlim <span class="op">=</span> <span class="fl">.001</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">weightvec</span><span class="op">[</span><span class="va">individuals</span><span class="op">$</span><span class="va">SERIALNO</span><span class="op">]</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">WGTP</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># step 2: adjust at person level</span></span>
<span>  <span class="va">totals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">source</span><span class="op">[</span>, <span class="va">vars_list</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">rake_prep</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/anesrake/man/anesrake.html" class="external-link">anesrake</a></span><span class="op">(</span></span>
<span>      <span class="va">totals</span>, <span class="va">individuals</span>, <span class="va">individuals</span><span class="op">$</span><span class="va">ID</span>,</span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">PWGTP</span> <span class="op">*</span> <span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">/</span> <span class="va">individuals</span><span class="op">$</span><span class="va">WGTP</span>,</span>
<span>      pctlim <span class="op">=</span> <span class="fl">.001</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">weightvec</span><span class="op">[</span><span class="va">individuals</span><span class="op">$</span><span class="va">ID</span><span class="op">]</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">PWGTP</span> <span class="op">*</span> <span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">/</span> <span class="va">individuals</span><span class="op">$</span><span class="va">WGTP</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculate proportions, and estimate parcel values</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">target</span><span class="op">[</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span> <span class="op">==</span> <span class="va">type</span>, <span class="op">]</span></span>
<span>    <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">individuals</span><span class="op">[</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span> <span class="op">==</span> <span class="va">type</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"weight"</span>, <span class="st">"status"</span>, <span class="va">return_vars</span><span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="va">i</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">return_vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span>, <span class="va">ii</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>          <span class="va">d</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">props</span>, each <span class="op">=</span> <span class="va">nd</span><span class="op">)</span>,</span>
<span>          <span class="va">nd</span>,</span>
<span>          dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">OBJECTID</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">estimate_twostep</span> <span class="op">&lt;-</span> <span class="fu">apply_method</span><span class="op">(</span><span class="va">data</span>, <span class="va">est_twostep</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generalized-raking">Generalized Raking<a class="anchor" aria-label="anchor" href="#generalized-raking"></a>
</h3>
<p>The two-step approach still mainly focuses on better aligning the
person-level weights – the household totals only match after the first
step, but are not considered in the second step. Alternative to this, we
might try to match the household- and person-level weights at the same
time with a generalized raking approach:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlfit.github.io/mlfit/" class="external-link">mlfit</a></span><span class="op">)</span></span>
<span><span class="va">est_grake</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">source</span>, <span class="va">target</span>, <span class="va">individuals</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">person</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars_list</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">l</span> <span class="op">&lt;-</span> <span class="va">vars_list</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>level <span class="op">=</span> <span class="va">l</span>, count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">source</span><span class="op">[</span>, <span class="va">l</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">n</span></span>
<span>    <span class="va">s</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">household</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span><span class="op">)</span></span>
<span>  <span class="va">household</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">household</span><span class="op">)</span><span class="op">)</span>, names <span class="op">=</span> <span class="va">household</span><span class="op">)</span></span>
<span>  <span class="va">observed_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span>, <span class="va">sum</span><span class="op">)</span></span>
<span>  <span class="va">household</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">observed_types</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">observed_types</span></span>
<span>  <span class="va">household</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>building_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">household</span><span class="op">)</span>, count <span class="op">=</span> <span class="va">household</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">household</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">count</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">household</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">household</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span>, count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">household</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">source</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^income_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">household</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    income_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">household</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, count <span class="op">=</span> <span class="va">household</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">household</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"building_type"</span>, <span class="st">"status"</span>, <span class="st">"income_cat"</span><span class="op">)</span></span>
<span>  <span class="va">household</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">household</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">l</span> <span class="op">&lt;-</span> <span class="va">household</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">l</span><span class="op">[</span><span class="va">l</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">individuals</span><span class="op">[</span>, <span class="va">var</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlfit.github.io/mlfit/reference/ml_problem.html" class="external-link">ml_problem</a></span><span class="op">(</span></span>
<span>    <span class="va">individuals</span>,</span>
<span>    field_names <span class="op">=</span> <span class="fu"><a href="https://mlfit.github.io/mlfit/reference/ml_problem.html" class="external-link">special_field_names</a></span><span class="op">(</span><span class="st">"SERIALNO"</span>, <span class="st">"ID"</span>, count <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span>,</span>
<span>    group_controls <span class="op">=</span> <span class="va">household</span>,</span>
<span>    individual_controls <span class="op">=</span> <span class="va">person</span>,</span>
<span>    prior_weights <span class="op">=</span> <span class="va">individuals</span><span class="op">$</span><span class="va">WGTP</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">individuals</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://mlfit.github.io/mlfit/reference/ml_fit.html" class="external-link">ml_fit_dss</a></span><span class="op">(</span><span class="va">m</span>, ginv <span class="op">=</span> <span class="va">solve</span><span class="op">)</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">PWGTP</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># if (all(individuals$WGTP == individuals$weight)) browser()</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">target</span><span class="op">[</span><span class="va">target</span><span class="op">$</span><span class="va">Unit_Type</span> <span class="op">==</span> <span class="va">type</span>, <span class="op">]</span></span>
<span>    <span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RENTER"</span>, <span class="st">"OWNER"</span><span class="op">)</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">individuals</span><span class="op">[</span></span>
<span>      <span class="va">individuals</span><span class="op">$</span><span class="va">building_type</span> <span class="op">==</span> <span class="va">type</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"weight"</span>, <span class="st">"status"</span>, <span class="va">return_vars</span><span class="op">)</span></span>
<span>    <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="va">i</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="va">s</span>, <span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">return_vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cat</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span>, <span class="va">ii</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ii</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="va">vars_list</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">!</span><span class="va">vars_list</span><span class="op">[[</span><span class="va">cat</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">props</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>          <span class="va">d</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">props</span>, each <span class="op">=</span> <span class="va">nd</span><span class="op">)</span>,</span>
<span>          <span class="va">nd</span>,</span>
<span>          dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">OBJECTID</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">estimate_grake</span> <span class="op">&lt;-</span> <span class="fu">apply_method</span><span class="op">(</span><span class="va">data</span>, <span class="va">est_grake</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="comparison">Comparison<a class="anchor" aria-label="anchor" href="#comparison"></a>
</h3>
<p>Now we can compare all of the considered methods within each of the
variables we used to inform the raking approaches:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="va">vars</span>, names <span class="op">=</span> <span class="va">vars</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    Prop <span class="op">=</span> <span class="va">estimate_redist</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"Prop Adj"</span> <span class="op">=</span> <span class="va">estimate_redist_adj</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    Baseline <span class="op">=</span> <span class="va">estimate_baseline</span><span class="op">$</span><span class="va">block_groups</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    Rake <span class="op">=</span> <span class="va">estimate_rake</span><span class="op">$</span><span class="va">block_groups</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"Rake 2 Step"</span> <span class="op">=</span> <span class="va">estimate_twostep</span><span class="op">$</span><span class="va">block_groups</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"Rake General"</span> <span class="op">=</span> <span class="va">estimate_grake</span><span class="op">$</span><span class="va">block_groups</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="va">block_groups</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">error</span>, Average <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">error</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="20%">
<col width="9%">
<col width="12%">
<col width="12%">
<col width="9%">
<col width="16%">
<col width="18%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="right">Prop</th>
<th align="right">Prop Adj</th>
<th align="right">Baseline</th>
<th align="right">Rake</th>
<th align="right">Rake 2 Step</th>
<th align="right">Rake General</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sex_male</td>
<td align="right">127.77</td>
<td align="right">110.01</td>
<td align="right">306.29</td>
<td align="right">308.98</td>
<td align="right">309.60</td>
<td align="right">351.73</td>
</tr>
<tr class="even">
<td align="left">sex_female</td>
<td align="right">114.37</td>
<td align="right">95.43</td>
<td align="right">306.76</td>
<td align="right">302.63</td>
<td align="right">302.04</td>
<td align="right">342.67</td>
</tr>
<tr class="odd">
<td align="left">race_other</td>
<td align="right">76.77</td>
<td align="right">74.87</td>
<td align="right">122.02</td>
<td align="right">97.47</td>
<td align="right">97.55</td>
<td align="right">116.73</td>
</tr>
<tr class="even">
<td align="left">race_white</td>
<td align="right">166.97</td>
<td align="right">143.43</td>
<td align="right">560.52</td>
<td align="right">424.96</td>
<td align="right">417.16</td>
<td align="right">570.54</td>
</tr>
<tr class="odd">
<td align="left">race_black</td>
<td align="right">62.83</td>
<td align="right">63.19</td>
<td align="right">83.32</td>
<td align="right">73.99</td>
<td align="right">74.22</td>
<td align="right">78.81</td>
</tr>
<tr class="even">
<td align="left">race_asian</td>
<td align="right">52.58</td>
<td align="right">54.12</td>
<td align="right">74.59</td>
<td align="right">67.93</td>
<td align="right">67.88</td>
<td align="right">75.18</td>
</tr>
<tr class="odd">
<td align="left">race_native</td>
<td align="right">5.92</td>
<td align="right">6.03</td>
<td align="right">106.85</td>
<td align="right">5.35</td>
<td align="right">5.22</td>
<td align="right">62.78</td>
</tr>
<tr class="even">
<td align="left">income_gt200</td>
<td align="right">50.25</td>
<td align="right">41.37</td>
<td align="right">436.81</td>
<td align="right">448.24</td>
<td align="right">442.88</td>
<td align="right">371.56</td>
</tr>
<tr class="odd">
<td align="left">income_lt10</td>
<td align="right">13.58</td>
<td align="right">14.02</td>
<td align="right">17.14</td>
<td align="right">16.76</td>
<td align="right">15.67</td>
<td align="right">15.15</td>
</tr>
<tr class="even">
<td align="left">income_45_50</td>
<td align="right">7.34</td>
<td align="right">7.90</td>
<td align="right">18.84</td>
<td align="right">9.35</td>
<td align="right">9.33</td>
<td align="right">18.67</td>
</tr>
<tr class="odd">
<td align="left">income_150_200</td>
<td align="right">32.55</td>
<td align="right">31.52</td>
<td align="right">82.02</td>
<td align="right">82.02</td>
<td align="right">82.02</td>
<td align="right">82.02</td>
</tr>
<tr class="even">
<td align="left">income_25_30</td>
<td align="right">8.28</td>
<td align="right">8.59</td>
<td align="right">7.99</td>
<td align="right">7.99</td>
<td align="right">7.99</td>
<td align="right">7.99</td>
</tr>
<tr class="odd">
<td align="left">income_35_40</td>
<td align="right">8.98</td>
<td align="right">8.92</td>
<td align="right">9.10</td>
<td align="right">9.10</td>
<td align="right">9.10</td>
<td align="right">9.10</td>
</tr>
<tr class="even">
<td align="left">income_15_20</td>
<td align="right">7.51</td>
<td align="right">7.87</td>
<td align="right">8.51</td>
<td align="right">8.51</td>
<td align="right">8.51</td>
<td align="right">8.51</td>
</tr>
<tr class="odd">
<td align="left">income_125_150</td>
<td align="right">22.48</td>
<td align="right">23.85</td>
<td align="right">53.26</td>
<td align="right">53.26</td>
<td align="right">53.26</td>
<td align="right">53.26</td>
</tr>
<tr class="even">
<td align="left">income_100_125</td>
<td align="right">20.63</td>
<td align="right">20.99</td>
<td align="right">51.62</td>
<td align="right">51.62</td>
<td align="right">51.62</td>
<td align="right">51.62</td>
</tr>
<tr class="odd">
<td align="left">Average</td>
<td align="right">48.68</td>
<td align="right">44.51</td>
<td align="right">140.35</td>
<td align="right">123.01</td>
<td align="right">122.13</td>
<td align="right">138.52</td>
</tr>
</tbody>
</table>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://biocomplexity.virginia.edu/institute/divisions/social-and-decision-analytics" class="external-link">Biocomplexity Institute</a>, Micah Iserman.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
